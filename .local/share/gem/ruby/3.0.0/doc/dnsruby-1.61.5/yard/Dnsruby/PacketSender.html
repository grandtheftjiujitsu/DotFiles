<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Dnsruby::PacketSender
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Dnsruby::PacketSender";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span>
     &raquo; 
    <span class="title">PacketSender</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Dnsruby::PacketSender
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Dnsruby::PacketSender</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd>Socket::Constants</dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/dnsruby/packet_sender.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: all</p>


  </div>
</div>
<div class="tags">
  

</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="authoritative_cache-classvariable" class="">@@authoritative_cache =
          
        </dt>
        <dd><pre class="code"><span class='const'><span class='object_link'><a href="Cache.html" title="Dnsruby::Cache (class)">Cache</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Cache.html#initialize-instance_method" title="Dnsruby::Cache#initialize (method)">new</a></span></span></pre></dd>
      
        <dt id="recursive_cache-classvariable" class="">@@recursive_cache =
          
        </dt>
        <dd><pre class="code"><span class='const'><span class='object_link'><a href="Cache.html" title="Dnsruby::Cache (class)">Cache</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Cache.html#initialize-instance_method" title="Dnsruby::Cache#initialize (method)">new</a></span></span></pre></dd>
      
    </dl>
  




  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#dnssec-instance_method" title="#dnssec (instance method)">#<strong>dnssec</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Use DNSSEC for this PacketSender  dnssec defaults to ON.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#ignore_truncation-instance_method" title="#ignore_truncation (instance method)">#<strong>ignore_truncation</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Don&#39;t worry if the response is truncated - return it anyway.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#no_tcp-instance_method" title="#no_tcp (instance method)">#<strong>no_tcp</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Use UDP only - don&#39;t use TCP  For test/debug purposes only  Defaults to false.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#packet_timeout-instance_method" title="#packet_timeout (instance method)">#<strong>packet_timeout</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute packet_timeout.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#port-instance_method" title="#port (instance method)">#<strong>port</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The port on the resolver to send queries to.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#recurse-instance_method" title="#recurse (instance method)">#<strong>recurse</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>should the Recursion Desired bit be set on queries?.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#server-instance_method" title="#server (instance method)">#<strong>server</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The address of the resolver to send queries to.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#src_address-instance_method" title="#src_address (instance method)">#<strong>src_address</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The source address to send queries from.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#tcp_pipelining-instance_method" title="#tcp_pipelining (instance method)">#<strong>tcp_pipelining</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Reuse tcp connection.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#tcp_pipelining_max_queries-instance_method" title="#tcp_pipelining_max_queries (instance method)">#<strong>tcp_pipelining_max_queries</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Limit the number of queries per pipeline.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#tsig-instance_method" title="#tsig (instance method)">#<strong>tsig</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The TSIG record to sign/verify messages with.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#udp_size-instance_method" title="#udp_size (instance method)">#<strong>udp_size</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The max UDP packet size.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#use_tcp-instance_method" title="#use_tcp (instance method)">#<strong>use_tcp</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Use TCP rather than UDP as the transport.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cache-class_method" title="cache (class method)">.<strong>cache</strong>(query, response)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cache_authoritative-class_method" title="cache_authoritative (class method)">.<strong>cache_authoritative</strong>(answer)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cache_recursive-class_method" title="cache_recursive (class method)">.<strong>cache_recursive</strong>(answer)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#clear_caches-class_method" title="clear_caches (class method)">.<strong>clear_caches</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#recursive_cache_length-class_method" title="recursive_cache_length (class method)">.<strong>recursive_cache_length</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_opt_rr-instance_method" title="#add_opt_rr (instance method)">#<strong>add_opt_rr</strong>(packet)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_src_port-instance_method" title="#add_src_port (instance method)">#<strong>add_src_port</strong>(p)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Can be a single Integer or a Range or an Array  If an invalid port is selected (one reserved by  IANA), then an ArgumentError will be raised.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_ipv6-instance_method" title="#check_ipv6 (instance method)">#<strong>check_ipv6</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_response-instance_method" title="#check_response (instance method)">#<strong>check_response</strong>(response, response_bytes, query, client_queue, client_query_id, tcp)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_tsig-instance_method" title="#check_tsig (instance method)">#<strong>check_tsig</strong>(query, response, response_bytes)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#close-instance_method" title="#close (instance method)">#<strong>close</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_next_src_port-instance_method" title="#get_next_src_port (instance method)">#<strong>get_next_src_port</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(*args)  &#x21d2; PacketSender </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Can take a hash with the following optional keys :.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#make_query-instance_method" title="#make_query (instance method)">#<strong>make_query</strong>(name, type = Types::A, klass = Classes::IN, set_cd = @dnssec)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#make_query_packet-instance_method" title="#make_query_packet (instance method)">#<strong>make_query_packet</strong>(packet, use_tcp = @use_tcp)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Prepare the packet for sending.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#prepare_for_dnssec-instance_method" title="#prepare_for_dnssec (instance method)">#<strong>prepare_for_dnssec</strong>(packet)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_async-instance_method" title="#send_async (instance method)">#<strong>send_async</strong>(*args)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Asynchronously send a Message to the server.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_dnsruby-instance_method" title="#send_dnsruby (instance method)">#<strong>send_dnsruby</strong>(query_bytes, query, client_query_id, client_queue, use_tcp)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method sends the packet using the built-in pure Ruby event loop, with no dependencies.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#src_address6=-instance_method" title="#src_address6= (instance method)">#<strong>src_address6=</strong>(arg)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Set the source address.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#src_port-instance_method" title="#src_port (instance method)">#<strong>src_port</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The source port to send queries from  Returns either a single Integer or an Array  e.g.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#src_port=-instance_method" title="#src_port= (instance method)">#<strong>src_port=</strong>(p)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Can be a single Integer or a Range or an Array  If an invalid port is selected (one reserved by  IANA), then an ArgumentError will be raised.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#tcp_pipeline_socket-instance_method" title="#tcp_pipeline_socket (instance method)">#<strong>tcp_pipeline_socket</strong>(src_port)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method returns the current tcp socket for pipelining  If this is the first time the method is called then the socket is bound to  @src_address:@src_port and connected to the remote dns server @server:@port.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#udp_packet_size-instance_method" title="#udp_packet_size (instance method)">#<strong>udp_packet_size</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the packet size to use for UDP.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(*args)  &#x21d2; <tt><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Can take a hash with the following optional keys :</p>

<pre class="code ruby"><code class="ruby">* :server
* :port
* :use_tcp
* :tcp_pipelining
* :tcp_pipelining_max_queries
* :no_tcp
* :ignore_truncation
* :src_address
* :src_address6
* :src_port
* :udp_size
* :tsig
* :packet_timeout
* :recurse
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 188</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_arg'>arg</span><span class='op'>=</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
  <span class='ivar'>@ipv6</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@packet_timeout</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver.html#DefaultPacketTimeout-constant" title="Dnsruby::Resolver::DefaultPacketTimeout (constant)">DefaultPacketTimeout</a></span></span>
  <span class='ivar'>@port</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver.html#DefaultPort-constant" title="Dnsruby::Resolver::DefaultPort (constant)">DefaultPort</a></span></span>
  <span class='ivar'>@udp_size</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver.html#DefaultUDPSize-constant" title="Dnsruby::Resolver::DefaultUDPSize (constant)">DefaultUDPSize</a></span></span>
  <span class='ivar'>@dnssec</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver.html#DefaultDnssec-constant" title="Dnsruby::Resolver::DefaultDnssec (constant)">DefaultDnssec</a></span></span>
  <span class='ivar'>@use_tcp</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@no_tcp</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@tsig</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@ignore_truncation</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@src_address</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&#39;</span></span>
  <span class='ivar'>@src_address6</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>::</span><span class='tstring_end'>&#39;</span></span>
  <span class='ivar'>@src_port</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
  <span class='ivar'>@recurse</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='ivar'>@tcp_pipelining</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='ivar'>@tcp_pipelining_max_queries</span> <span class='op'>=</span> <span class='symbol'>:infinite</span>
  <span class='ivar'>@use_counts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_arg'>arg</span><span class='op'>==</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='comment'>#  Get default config
</span>    <span class='id identifier rubyid_config'>config</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Config.html" title="Dnsruby::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Config.html#initialize-instance_method" title="Dnsruby::Config#initialize (method)">new</a></span></span>
    <span class='comment'>#         @server = config.nameserver[0]
</span>  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_arg'>arg</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span> <span class='const'>String</span><span class='rparen'>)</span>
    <span class='ivar'>@server</span><span class='op'>=</span><span class='id identifier rubyid_arg'>arg</span>
  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_arg'>arg</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span> <span class='const'><span class='object_link'><a href="Name.html" title="Dnsruby::Name (class)">Name</a></span></span><span class='rparen'>)</span>
    <span class='ivar'>@server</span><span class='op'>=</span><span class='id identifier rubyid_arg'>arg</span>
  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_arg'>arg</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span> <span class='const'>Hash</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg'>arg</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span>
      <span class='kw'>begin</span>
        <span class='kw'>if</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_attr'>attr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>src_address</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='op'>||</span><span class='lparen'>(</span><span class='id identifier rubyid_attr'>attr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>src_address6</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
            <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_arg'>arg</span><span class='lbracket'>[</span><span class='id identifier rubyid_attr'>attr</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_arg'>arg</span><span class='lbracket'>[</span><span class='id identifier rubyid_attr'>attr</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_attr'>attr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>=</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_arg'>arg</span><span class='lbracket'>[</span><span class='id identifier rubyid_attr'>attr</span><span class='rbracket'>]</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PacketSender : Argument </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_attr'>attr</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_arg'>arg</span><span class='lbracket'>[</span><span class='id identifier rubyid_attr'>attr</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> not valid : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
      <span class='kw'>end</span>
      <span class='comment'>#         end
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># Check server is IP
</span>  <span class='ivar'>@server</span><span class='op'>=</span><span class='const'><span class='object_link'><a href="Config.html" title="Dnsruby::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_resolve_server'><span class='object_link'><a href="Config.html#resolve_server-class_method" title="Dnsruby::Config.resolve_server (method)">resolve_server</a></span></span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_check_ipv6'>check_ipv6</span>
  <span class='comment'>#       ResolverRegister::register_single_resolver(self)
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="dnssec=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="dnssec-instance_method">
  
    #<strong>dnssec</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Use DNSSEC for this PacketSender</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_dnssec'>dnssec</span> <span class='id identifier rubyid_defaults'>defaults</span> <span class='id identifier rubyid_to'>to</span> <span class='const'>ON</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


122
123
124</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 122</span>

<span class='kw'>def</span> <span class='id identifier rubyid_dnssec'>dnssec</span>
  <span class='ivar'>@dnssec</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="ignore_truncation=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="ignore_truncation-instance_method">
  
    #<strong>ignore_truncation</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Don&#39;t worry if the response is truncated - return it anyway.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Defaults</span> <span class='id identifier rubyid_to'>to</span> <span class='kw'>false</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


100
101
102</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 100</span>

<span class='kw'>def</span> <span class='id identifier rubyid_ignore_truncation'>ignore_truncation</span>
  <span class='ivar'>@ignore_truncation</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="no_tcp=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="no_tcp-instance_method">
  
    #<strong>no_tcp</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Use UDP only - don&#39;t use TCP</p>

<pre class="code ruby"><code class="ruby">For test/debug purposes only
Defaults to false
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


92
93
94</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 92</span>

<span class='kw'>def</span> <span class='id identifier rubyid_no_tcp'>no_tcp</span>
  <span class='ivar'>@no_tcp</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="packet_timeout=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="packet_timeout-instance_method">
  
    #<strong>packet_timeout</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute packet_timeout.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


69
70
71</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 69</span>

<span class='kw'>def</span> <span class='id identifier rubyid_packet_timeout'>packet_timeout</span>
  <span class='ivar'>@packet_timeout</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="port=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="port-instance_method">
  
    #<strong>port</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The port on the resolver to send queries to.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Defaults</span> <span class='id identifier rubyid_to'>to</span> <span class='int'>53</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


74
75
76</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 74</span>

<span class='kw'>def</span> <span class='id identifier rubyid_port'>port</span>
  <span class='ivar'>@port</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="recurse=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="recurse-instance_method">
  
    #<strong>recurse</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>should the Recursion Desired bit be set on queries?</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Defaults</span> <span class='id identifier rubyid_to'>to</span> <span class='kw'>true</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


110
111
112</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 110</span>

<span class='kw'>def</span> <span class='id identifier rubyid_recurse'>recurse</span>
  <span class='ivar'>@recurse</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="server=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="server-instance_method">
  
    #<strong>server</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The address of the resolver to send queries to</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


118
119
120</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 118</span>

<span class='kw'>def</span> <span class='id identifier rubyid_server'>server</span>
  <span class='ivar'>@server</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="src_address=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="src_address-instance_method">
  
    #<strong>src_address</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The source address to send queries from</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Defaults</span> <span class='id identifier rubyid_to'>to</span> <span class='id identifier rubyid_localhost'>localhost</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


105
106
107</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 105</span>

<span class='kw'>def</span> <span class='id identifier rubyid_src_address'>src_address</span>
  <span class='ivar'>@src_address</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="tcp_pipelining=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="tcp_pipelining-instance_method">
  
    #<strong>tcp_pipelining</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Reuse tcp connection</p>

<p>Defaults to false</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


84
85
86</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 84</span>

<span class='kw'>def</span> <span class='id identifier rubyid_tcp_pipelining'>tcp_pipelining</span>
  <span class='ivar'>@tcp_pipelining</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="tcp_pipelining_max_queries=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="tcp_pipelining_max_queries-instance_method">
  
    #<strong>tcp_pipelining_max_queries</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Limit the number of queries per pipeline</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 87</span>

<span class='kw'>def</span> <span class='id identifier rubyid_tcp_pipelining_max_queries'>tcp_pipelining_max_queries</span>
  <span class='ivar'>@tcp_pipelining_max_queries</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="tsig=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="tsig-instance_method">
  
    #<strong>tsig</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The TSIG record to sign/verify messages with</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 95</span>

<span class='kw'>def</span> <span class='id identifier rubyid_tsig'>tsig</span>
  <span class='ivar'>@tsig</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="udp_size=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="udp_size-instance_method">
  
    #<strong>udp_size</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The max UDP packet size</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Defaults</span> <span class='id identifier rubyid_to'>to</span> <span class='int'>512</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


115
116
117</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 115</span>

<span class='kw'>def</span> <span class='id identifier rubyid_udp_size'>udp_size</span>
  <span class='ivar'>@udp_size</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="use_tcp=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="use_tcp-instance_method">
  
    #<strong>use_tcp</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Use TCP rather than UDP as the transport.</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Defaults</span> <span class='id identifier rubyid_to'>to</span> <span class='kw'>false</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 79</span>

<span class='kw'>def</span> <span class='id identifier rubyid_use_tcp'>use_tcp</span>
  <span class='ivar'>@use_tcp</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="cache-class_method">
  
    .<strong>cache</strong>(query, response)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 29</span>

<span class='kw'>def</span> <span class='const'><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cache'>cache</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_cached'>cached</span>
  <span class='comment'>#  ONLY cache the response if it is not an update response
</span>  <span class='id identifier rubyid_question'>question</span> <span class='op'>=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_do_caching'>do_caching</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span> <span class='op'>!=</span> <span class='const'><span class='object_link'><a href="Update.html" title="Dnsruby::Update (class)">Update</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_question'>question</span><span class='period'>.</span><span class='id identifier rubyid_qtype'>qtype</span> <span class='op'>!=</span> <span class='const'><span class='object_link'><a href="Types.html" title="Dnsruby::Types (class)">Types</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Types.html#AXFR-constant" title="Dnsruby::Types::AXFR (constant)">AXFR</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_question'>question</span><span class='period'>.</span><span class='id identifier rubyid_qtype'>qtype</span> <span class='op'>!=</span> <span class='const'><span class='object_link'><a href="Types.html" title="Dnsruby::Types (class)">Types</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Types.html#IXFR-constant" title="Dnsruby::Types::IXFR (constant)">IXFR</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_rcode'>rcode</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="RCode.html" title="Dnsruby::RCode (class)">RCode</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="RCode.html#NOERROR-constant" title="Dnsruby::RCode::NOERROR (constant)">NOERROR</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span><span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_tsig'>tsig</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span> <span class='op'>!=</span> <span class='const'><span class='object_link'><a href="Update.html" title="Dnsruby::Update (class)">Update</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_ancount'>ancount</span> <span class='op'>&gt;</span> <span class='int'>0</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='comment'># # @TODO@ What about TSIG-signed responses?
</span>    <span class='comment'>#  Don&#39;t cache any packets with &quot;*&quot; in the query name! (RFC1034 sec 4.3.3)
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_question'>question</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='comment'>#  Now cache response RRSets
</span>      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_rd'>rd</span><span class='rparen'>)</span>
        <span class='const'><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cache_recursive'><span class='object_link'><a href="#cache_recursive-class_method" title="Dnsruby::PacketSender.cache_recursive (method)">cache_recursive</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span><span class='semicolon'>;</span>
      <span class='kw'>else</span>
        <span class='const'><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cache_authoritative'><span class='object_link'><a href="#cache_authoritative-class_method" title="Dnsruby::PacketSender.cache_authoritative (method)">cache_authoritative</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span><span class='semicolon'>;</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cache_authoritative-class_method">
  
    .<strong>cache_authoritative</strong>(answer)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


51
52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 51</span>

<span class='kw'>def</span> <span class='const'><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cache_authoritative'>cache_authoritative</span><span class='lparen'>(</span><span class='id identifier rubyid_answer'>answer</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_answer'>answer</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_aa'>aa</span>
  <span class='cvar'>@@authoritative_cache</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_answer'>answer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cache_recursive-class_method">
  
    .<strong>cache_recursive</strong>(answer)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 56</span>

<span class='kw'>def</span> <span class='const'><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cache_recursive'>cache_recursive</span><span class='lparen'>(</span><span class='id identifier rubyid_answer'>answer</span><span class='rparen'>)</span>
  <span class='cvar'>@@recursive_cache</span><span class='period'>.</span><span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_answer'>answer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="clear_caches-class_method">
  
    .<strong>clear_caches</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 60</span>

<span class='kw'>def</span> <span class='const'><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></span><span class='period'>.</span><span class='id identifier rubyid_clear_caches'>clear_caches</span>
  <span class='cvar'>@@recursive_cache</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
  <span class='cvar'>@@authoritative_cache</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="recursive_cache_length-class_method">
  
    .<strong>recursive_cache_length</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


65
66
67</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 65</span>

<span class='kw'>def</span> <span class='const'><span class='object_link'><a href="" title="Dnsruby::PacketSender (class)">PacketSender</a></span></span><span class='period'>.</span><span class='id identifier rubyid_recursive_cache_length'>recursive_cache_length</span>
  <span class='cvar'>@@recursive_cache</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_opt_rr-instance_method">
  
    #<strong>add_opt_rr</strong>(packet)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


735
736
737
738
739
740
741
742
743
744</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 735</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_opt_rr'>add_opt_rr</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>;; Adding EDNS extension with UDP packetsize  </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>.\n</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='comment'>#  RFC 3225
</span>  <span class='id identifier rubyid_optrr'>optrr</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="RR.html" title="Dnsruby::RR (class)">RR</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="RR/OPT.html" title="Dnsruby::RR::OPT (class)">OPT</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="RR/OPT.html#initialize-instance_method" title="Dnsruby::RR::OPT#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span><span class='rparen'>)</span>

  <span class='comment'>#  Only one OPT RR allowed per packet - do we already have one?
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_additional'>additional</span><span class='period'>.</span><span class='id identifier rubyid_rrset'>rrset</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Types.html" title="Dnsruby::Types (class)">Types</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Types.html#OPT-constant" title="Dnsruby::Types::OPT (constant)">OPT</a></span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_rrs'>rrs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_additional'>add_additional</span><span class='lparen'>(</span><span class='id identifier rubyid_optrr'>optrr</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_src_port-instance_method">
  
    #<strong>add_src_port</strong>(p)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Can be a single Integer or a Range or an Array</p>

<pre class="code ruby"><code class="ruby">If an invalid port is selected (one reserved by
IANA), then an ArgumentError will be raised.
&quot;0&quot; means &quot;any valid port&quot; - this is only a viable
option if it is the only port in the list.
An ArgumentError will be raised if &quot;0&quot; is added to
an existing set of source ports.

       res.add_src_port(60000)
       res.add_src_port([60001,60005,60010])
       res.add_src_port(60015..60115)
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


590
591
592
593
594
595
596
597
598
599
600</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 590</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_src_port'>add_src_port</span><span class='lparen'>(</span><span class='id identifier rubyid_p'>p</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_check_port'><span class='object_link'><a href="Resolver.html#check_port-class_method" title="Dnsruby::Resolver.check_port (method)">check_port</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_p'>p</span><span class='comma'>,</span> <span class='ivar'>@src_port</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='period'>.</span><span class='id identifier rubyid_get_ports_from'><span class='object_link'><a href="Resolver.html#get_ports_from-class_method" title="Dnsruby::Resolver.get_ports_from (method)">get_ports_from</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_p'>p</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='ivar'>@src_port</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_x'>x</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>src_port of 0 only allowed as only src_port value (currently </span><span class='embexpr_beg'>#{</span><span class='ivar'>@src_port</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> values</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='ivar'>@src_port</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_x'>x</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_ipv6-instance_method">
  
    #<strong>check_ipv6</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


236
237
238
239
240
241
242
243
244
245
246
247
248
249
250</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 236</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_ipv6'>check_ipv6</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="IPv4.html" title="Dnsruby::IPv4 (class)">IPv4</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create'><span class='object_link'><a href="IPv4.html#create-class_method" title="Dnsruby::IPv4.create (method)">create</a></span></span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='rparen'>)</span>
    <span class='comment'>#         @src_address = &#39;0.0.0.0&#39;
</span>    <span class='ivar'>@ipv6</span><span class='op'>=</span><span class='kw'>false</span>
  <span class='kw'>rescue</span> <span class='const'>Exception</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="IPv6.html" title="Dnsruby::IPv6 (class)">IPv6</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create'><span class='object_link'><a href="IPv6.html#create-class_method" title="Dnsruby::IPv6.create (method)">create</a></span></span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='rparen'>)</span>
      <span class='comment'>#           @src_address6 = &#39;::&#39;
</span>      <span class='ivar'>@ipv6</span><span class='op'>=</span><span class='kw'>true</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Server is neither IPv4 or IPv6!\n</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_response-instance_method">
  
    #<strong>check_response</strong>(response, response_bytes, query, client_queue, client_query_id, tcp)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 624</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_response'>check_response</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_response_bytes'>response_bytes</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_tcp'>tcp</span><span class='rparen'>)</span>
  <span class='comment'>#  @TODO@ Should send_raw avoid this?
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_send_raw'>send_raw</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_sig_value'>sig_value</span> <span class='op'>=</span> <span class='id identifier rubyid_check_tsig'>check_tsig</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_response_bytes'>response_bytes</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_sig_value'>sig_value</span> <span class='op'>!=</span> <span class='symbol'>:okay</span><span class='rparen'>)</span>
      <span class='comment'>#  Should send error back up to Resolver here, and then NOT QUERY AGAIN!!!
</span>      <span class='kw'>return</span> <span class='id identifier rubyid_sig_value'>sig_value</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_get_header_rcode'>get_header_rcode</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="RCode.html" title="Dnsruby::RCode (class)">RCode</a></span></span><span class='period'>.</span><span class='const'>FORMERR</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
        <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_arcount'>arcount</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='comment'># Raise an error
</span>      <span class='kw'>return</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='comment'>#  Should check that question section is same as question that was sent! RFC 5452
</span>    <span class='comment'>#  If it&#39;s not an update...
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Update.html" title="Dnsruby::Update (class)">Update</a></span></span><span class='rparen'>)</span>
      <span class='comment'>#  @TODO@!!
</span>    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='op'>||</span>
          <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='period'>.</span><span class='id identifier rubyid_labels'>labels</span> <span class='op'>!=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='period'>.</span><span class='id identifier rubyid_labels'>labels</span><span class='rparen'>)</span> <span class='op'>||</span>
          <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qtype'>qtype</span> <span class='op'>!=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qtype'>qtype</span><span class='rparen'>)</span> <span class='op'>||</span>
          <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qclass'>qclass</span> <span class='op'>!=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qclass'>qclass</span><span class='rparen'>)</span> <span class='op'>||</span>
          <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>!=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span> <span class='op'>||</span>
          <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='op'>!=</span> <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='const'><span class='object_link'><a href="TheLog.html" title="Dnsruby::TheLog (class)">TheLog</a></span></span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Incorrect packet returned : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='kw'>return</span> <span class='kw'>false</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='comment'># end
</span>    <span class='comment'>#  IF WE GET FORMERR BACK HERE (and we have EDNS0 on) THEN
</span>    <span class='comment'>#  TRY AGAIN WITH NO OPT RECORDS! (rfc2671 section 5.3)
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_get_header_rcode'>get_header_rcode</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="RCode.html" title="Dnsruby::RCode (class)">RCode</a></span></span><span class='period'>.</span><span class='const'>FORMERR</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
        <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_arcount'>arcount</span> <span class='op'>&gt;</span> <span class='int'>0</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='comment'>#  try resending the message with no OPT record
</span>      <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_remove_additional'>remove_additional</span>
      <span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_send_raw'>send_raw</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_send_async'>send_async</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='kw'>false</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_tc'>tc</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_tcp'>tcp</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@ignore_truncation</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@no_tcp</span><span class='rparen'>)</span>
        <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Truncated response - not resending over TCP as no_tcp==true</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
      <span class='kw'>else</span>
        <span class='comment'>#  Try to resend over tcp
</span>        <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Truncated - resending over TCP</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
        <span class='comment'>#  @TODO@ Are the query options used correctly here? DNSSEC in particular...
</span>        <span class='comment'>#         query.send_raw = true # Make sure that the packet is not messed with.
</span>        <span class='id identifier rubyid_send_async'>send_async</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span>
        <span class='kw'>return</span> <span class='kw'>false</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_tsig-instance_method">
  
    #<strong>check_tsig</strong>(query, response, response_bytes)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 679</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_tsig'>check_tsig</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_response_bytes'>response_bytes</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_tsig'>tsig</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_tsig'>tsig</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_tsig'>tsig</span><span class='period'>.</span><span class='id identifier rubyid_verify'>verify</span><span class='lparen'>(</span><span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_response_bytes'>response_bytes</span><span class='rparen'>)</span>
        <span class='comment'>#  Discard packet and wait for correctly signed response
</span>        <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TSIG authentication failed!</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
        <span class='kw'>return</span> <span class='const'><span class='object_link'><a href="TsigError.html" title="Dnsruby::TsigError (class)">TsigError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='comment'>#  Treated as having format error and discarded (RFC2845, 4.6)
</span>      <span class='comment'>#  but return a different error code, because some servers fail at
</span>      <span class='comment'>#  this
</span>      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Expecting TSIG signed response, but got unsigned response - discarding</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
      <span class='kw'>return</span> <span class='const'><span class='object_link'><a href="TsigNotSignedResponseError.html" title="Dnsruby::TsigNotSignedResponseError (class)">TsigNotSignedResponseError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='kw'>end</span>
  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_tsig'>tsig</span><span class='rparen'>)</span>
    <span class='comment'>#  Error - signed response to unsigned query
</span>    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Signed response to unsigned query</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>return</span> <span class='const'><span class='object_link'><a href="TsigError.html" title="Dnsruby::TsigError (class)">TsigError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='symbol'>:okay</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="close-instance_method">
  
    #<strong>close</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 252</span>

<span class='kw'>def</span> <span class='id identifier rubyid_close'>close</span>
  <span class='comment'>#  @TODO@ What about closing?
</span>  <span class='comment'>#  Any queries to complete? Sockets to close?
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_next_src_port-instance_method">
  
    #<strong>get_next_src_port</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 603</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_next_src_port'>get_next_src_port</span>
  <span class='comment'># Different OSes have different interpretations of &quot;random port&quot; here.
</span>  <span class='comment'># Apparently, Linux will just give you the same port as last time, unless it is still
</span>  <span class='comment'># open, in which case you get n+1.
</span>  <span class='comment'># We need to determine an actual (random) number here, then ask the OS for it, and
</span>  <span class='comment'># continue until we get one.
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@src_port</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_candidate'>candidate</span> <span class='op'>=</span> <span class='op'>-</span><span class='int'>1</span>
    <span class='comment'>#         # better to construct an array of all the ports we *can* use, and then just pick one at random!
</span>    <span class='comment'>#         candidate = Iana::UNRESERVED_PORTS[rand(Iana::UNRESERVED_PORTS.length())]
</span>    <span class='comment'>#         #        while (!(Resolver.port_in_range(candidate)))
</span>    <span class='comment'>#         #          candidate = (rand(65535-1024) + 1024)
</span>    <span class='comment'>#         #        end
</span>    <span class='comment'>#  @TODO@ Should probably construct a bitmap of the IANA ports...
</span>    <span class='id identifier rubyid_candidate'>candidate</span> <span class='op'>=</span> <span class='int'>50000</span> <span class='op'>+</span> <span class='lparen'>(</span><span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>15535</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='comment'># pick one over 50000
</span>    <span class='kw'>return</span> <span class='id identifier rubyid_candidate'>candidate</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_pos'>pos</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='ivar'>@src_port</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='ivar'>@src_port</span><span class='lbracket'>[</span><span class='id identifier rubyid_pos'>pos</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="make_query-instance_method">
  
    #<strong>make_query</strong>(name, type = Types::A, klass = Classes::IN, set_cd = @dnssec)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


702
703
704
705
706
707
708
709
710</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 702</span>

<span class='kw'>def</span> <span class='id identifier rubyid_make_query'>make_query</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Types.html" title="Dnsruby::Types (class)">Types</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Types.html#A-constant" title="Dnsruby::Types::A (constant)">A</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Classes.html" title="Dnsruby::Classes (class)">Classes</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Classes.html#IN-constant" title="Dnsruby::Classes::IN (constant)">IN</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_set_cd'>set_cd</span><span class='op'>=</span><span class='ivar'>@dnssec</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Message.html" title="Dnsruby::Message (class)">Message</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Message.html#initialize-instance_method" title="Dnsruby::Message#initialize (method)">new</a></span></span>
  <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_rd'>rd</span> <span class='op'>=</span> <span class='int'>1</span>
  <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_add_question'>add_question</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span><span class='comma'>,</span> <span class='id identifier rubyid_klass'>klass</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@dnssec</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_cd'>cd</span> <span class='op'>=</span> <span class='id identifier rubyid_set_cd'>set_cd</span> <span class='comment'># We do our own validation by default
</span>  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_msg'>msg</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="make_query_packet-instance_method">
  
    #<strong>make_query_packet</strong>(packet, use_tcp = @use_tcp)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Prepare the packet for sending</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 713</span>

<span class='kw'>def</span> <span class='id identifier rubyid_make_query_packet'>make_query_packet</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='comma'>,</span> <span class='id identifier rubyid_use_tcp'>use_tcp</span> <span class='op'>=</span> <span class='ivar'>@use_tcp</span><span class='rparen'>)</span> <span class='comment'>#:nodoc: all
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_send_raw'>send_raw</span><span class='rparen'>)</span> <span class='comment'># Don&#39;t mess with this packet!
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_opcode'>opcode</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="OpCode.html" title="Dnsruby::OpCode (class)">OpCode</a></span></span><span class='period'>.</span><span class='const'>QUERY</span> <span class='op'>||</span> <span class='ivar'>@recurse</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_rd'>rd</span><span class='op'>=</span><span class='ivar'>@recurse</span>
    <span class='kw'>end</span>

    <span class='comment'>#  Only do this if the packet has not been prepared already!
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@dnssec</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_prepare_for_dnssec'>prepare_for_dnssec</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span> <span class='op'>&gt;</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver.html#DefaultUDPSize-constant" title="Dnsruby::Resolver::DefaultUDPSize (constant)">DefaultUDPSize</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='rparen'>)</span>
      <span class='comment'>#       if ((udp_packet_size &gt; Resolver::DefaultUDPSize) &amp;&amp; !use_tcp)
</span>      <span class='comment'>#  @TODO@ What if an existing OPT RR is not big enough? Should we replace it?
</span>      <span class='id identifier rubyid_add_opt_rr'>add_opt_rr</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@tsig</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_signed?'>signed?</span><span class='rparen'>)</span>
    <span class='ivar'>@tsig</span><span class='period'>.</span><span class='id identifier rubyid_apply'>apply</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_encode'>encode</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="prepare_for_dnssec-instance_method">
  
    #<strong>prepare_for_dnssec</strong>(packet)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 746</span>

<span class='kw'>def</span> <span class='id identifier rubyid_prepare_for_dnssec'>prepare_for_dnssec</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='rparen'>)</span>
  <span class='comment'>#  RFC 4035
</span>  <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>;; Adding EDNS extension with UDP packetsize </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span><span class='embexpr_end'>}</span><span class='tstring_content'> and DNS OK bit set\n</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_optrr'>optrr</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="RR.html" title="Dnsruby::RR (class)">RR</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="RR/OPT.html" title="Dnsruby::RR::OPT (class)">OPT</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="RR/OPT.html#initialize-instance_method" title="Dnsruby::RR::OPT#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span><span class='rparen'>)</span> <span class='comment'># Decimal UDPpayload
</span>  <span class='id identifier rubyid_optrr'>optrr</span><span class='period'>.</span><span class='id identifier rubyid_dnssec_ok'>dnssec_ok</span><span class='op'>=</span><span class='kw'>true</span>

  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_additional'>additional</span><span class='period'>.</span><span class='id identifier rubyid_rrset'>rrset</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="Types.html" title="Dnsruby::Types (class)">Types</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Types.html#OPT-constant" title="Dnsruby::Types::OPT (constant)">OPT</a></span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_rrs'>rrs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_additional'>add_additional</span><span class='lparen'>(</span><span class='id identifier rubyid_optrr'>optrr</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_ad'>ad</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='comment'># RFC 4035 section 4.6
</span>
  <span class='comment'>#  SHOULD SET CD HERE!!!
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_do_validation'>do_validation</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_cd'>cd</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='const'><span class='object_link'><a href="Dnssec.html" title="Dnsruby::Dnssec (class)">Dnssec</a></span></span><span class='period'>.</span><span class='id identifier rubyid_no_keys?'><span class='object_link'><a href="Dnssec.html#no_keys%3F-class_method" title="Dnsruby::Dnssec.no_keys? (method)">no_keys?</a></span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_cd'>cd</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_async-instance_method">
  
    #<strong>send_async</strong>(*args)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Asynchronously send a Message to the server. The send can be done using just Dnsruby. Support for EventMachine has been deprecated.</p>

<h2 id="label-Dnsruby+pure+Ruby+event+loop+-3A">Dnsruby pure Ruby event loop :</h2>

<p>A client_queue is supplied by the client, along with an optional client_query_id to identify the response. The client_query_id is generated, if not supplied, and returned to the client. When the response is known, the tuple (query_id, response_message, response_exception) is put in the queue for the client to process.</p>

<p>The query is sent synchronously in the caller&#39;s thread. The select thread is then used to listen for and process the response (up to pushing it to the client_queue). The client thread is then used to retrieve the response and deal with it.</p>

<p>Takes :</p>
<ul><li>
<p>msg - the message to send</p>
</li><li>
<p>client_queue - a Queue to push the response to, when it arrives</p>
</li><li>
<p>client_query_id - an optional ID to identify the query to the client</p>
</li><li>
<p>use_tcp - whether to use TCP (defaults to PacketSender.use_tcp)</p>
</li></ul>

<p>Returns :</p>
<ul><li>
<p>client_query_id - to identify the query response to the client. This ID is</p>
</li></ul>

<p>generated if it is not passed in by the client</p>

<p>If the native Dsnruby networking layer is being used, then this method returns the client_query_id</p>

<pre class="code ruby"><code class="ruby">id = res.send_async(msg, queue)
NOT SUPPORTED : id = res.send_async(msg, queue, use_tcp)
id = res.send_async(msg, queue, id)
id = res.send_async(msg, queue, id, use_tcp)
</code></pre>

<p>Use Message#send_raw to send the packet with an untouched header. Use Message#do_caching to tell dnsruby whether to check the cache before sending, and update the cache upon receiving a response. Use Message#do_validation to tell dnsruby whether or not to do DNSSEC validation for this particular packet (assuming SingleResolver#dnssec == true) Note that these options should not normally be used!</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 297</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_async'>send_async</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span> <span class='comment'># msg, client_queue, client_query_id, use_tcp=@use_tcp)
</span>  <span class='comment'>#  @TODO@ Need to select a good Header ID here - see forgery-resilience RFC draft for details
</span>  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_client_query_id'>client_query_id</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_client_queue'>client_queue</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_use_tcp'>use_tcp</span> <span class='op'>=</span> <span class='ivar'>@use_tcp</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span> <span class='const'>String</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Message.html" title="Dnsruby::Message (class)">Message</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Message.html#initialize-instance_method" title="Dnsruby::Message#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@dnssec</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_cd'>cd</span> <span class='op'>=</span> <span class='ivar'>@dnssec</span> <span class='comment'># we&#39;ll do our own validation by default
</span>      <span class='kw'>if</span> <span class='lparen'>(</span><span class='const'><span class='object_link'><a href="Dnssec.html" title="Dnsruby::Dnssec (class)">Dnssec</a></span></span><span class='period'>.</span><span class='id identifier rubyid_no_keys?'><span class='object_link'><a href="Dnssec.html#no_keys%3F-class_method" title="Dnsruby::Dnssec.no_keys? (method)">no_keys?</a></span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_cd'>cd</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>1</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='op'>==</span><span class='const'>Queue</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_client_queue'>client_queue</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span>
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>2</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_use_tcp'>use_tcp</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>2</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_client_query_id'>client_query_id</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span>
      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>3</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_use_tcp'>use_tcp</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='int'>3</span><span class='rbracket'>]</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'>#  Need to keep track of the request mac (if using tsig) so we can validate the response (RFC2845 4.1)
</span>  <span class='comment'>#       #Are we using EventMachine or native Dnsruby?
</span>  <span class='comment'>#       if (Resolver.eventmachine?)
</span>  <span class='comment'>#         return send_eventmachine(query_packet, msg, client_query_id, client_queue, use_tcp)
</span>  <span class='comment'>#       else
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_client_query_id'>client_query_id</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>10000</span><span class='rparen'>)</span> <span class='comment'># is this safe?!
</span>  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_query_packet'>query_packet</span> <span class='op'>=</span> <span class='id identifier rubyid_make_query_packet'>make_query_packet</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="EncodeError.html" title="Dnsruby::EncodeError (class)">EncodeError</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_err'>err</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_st'>st</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="SelectThread.html" title="Dnsruby::SelectThread (class)">SelectThread</a></span></span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span>
    <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_do_caching'>do_caching</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span> <span class='op'>!=</span> <span class='const'><span class='object_link'><a href="Update.html" title="Dnsruby::Update (class)">Update</a></span></span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='comment'>#  Check the cache!!
</span>    <span class='id identifier rubyid_cachedanswer'>cachedanswer</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_rd'>rd</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_cachedanswer'>cachedanswer</span> <span class='op'>=</span> <span class='cvar'>@@recursive_cache</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_cachedanswer'>cachedanswer</span> <span class='op'>=</span> <span class='cvar'>@@authoritative_cache</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_cachedanswer'>cachedanswer</span><span class='rparen'>)</span>
      <span class='const'><span class='object_link'><a href="TheLog.html" title="Dnsruby::TheLog (class)">TheLog</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sending cached answer to client\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='comment'>#  @TODO@ Fix up the header - ID and flags
</span>      <span class='id identifier rubyid_cachedanswer'>cachedanswer</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
      <span class='comment'>#  If we can find the answer, send it to the client straight away
</span>      <span class='comment'>#  Post the result to the client using SelectThread
</span>      <span class='id identifier rubyid_st'>st</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="SelectThread.html" title="Dnsruby::SelectThread (class)">SelectThread</a></span></span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span>
      <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_response_to_select'>push_response_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_cachedanswer'>cachedanswer</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'>#  Otherwise, run the query
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_query_packet'>query_packet</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@no_tcp</span><span class='rparen'>)</span>
      <span class='comment'>#  Can&#39;t send the message - abort!
</span>      <span class='id identifier rubyid_err'>err</span><span class='op'>=</span><span class='const'>IOError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Can&#39;t send message - too big for UDP and no_tcp=true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Query packet length exceeds max UDP packet size - using TCP</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_use_tcp'>use_tcp</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_send_dnsruby'>send_dnsruby</span><span class='lparen'>(</span><span class='id identifier rubyid_query_packet'>query_packet</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span>
  <span class='comment'>#       end
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_dnsruby-instance_method">
  
    #<strong>send_dnsruby</strong>(query_bytes, query, client_query_id, client_queue, use_tcp)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method sends the packet using the built-in pure Ruby event loop, with no dependencies.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 438</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_dnsruby'>send_dnsruby</span><span class='lparen'>(</span><span class='id identifier rubyid_query_bytes'>query_bytes</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='rparen'>)</span> <span class='comment'>#:nodoc: all
</span>  <span class='id identifier rubyid_endtime'>endtime</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='ivar'>@packet_timeout</span>
  <span class='comment'>#  First send the query (synchronously)
</span>  <span class='id identifier rubyid_st'>st</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="SelectThread.html" title="Dnsruby::SelectThread (class)">SelectThread</a></span></span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span>
  <span class='id identifier rubyid_socket'>socket</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_runnextportloop'>runnextportloop</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_numtries'>numtries</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_src_address'>src_address</span> <span class='op'>=</span> <span class='ivar'>@src_address</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@ipv6</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_src_address'>src_address</span> <span class='op'>=</span> <span class='ivar'>@src_address6</span>
  <span class='kw'>end</span>
  <span class='kw'>while</span> <span class='lparen'>(</span><span class='id identifier rubyid_runnextportloop'>runnextportloop</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_numtries'>numtries</span> <span class='op'>+=</span> <span class='int'>1</span>
      <span class='id identifier rubyid_src_port'>src_port</span> <span class='op'>=</span> <span class='id identifier rubyid_get_next_src_port'>get_next_src_port</span>
      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='rparen'>)</span>
        <span class='kw'>begin</span>
          <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@tcp_pipelining</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_socket'>socket</span><span class='comma'>,</span> <span class='id identifier rubyid_new_socket'>new_socket</span> <span class='op'>=</span> <span class='id identifier rubyid_tcp_pipeline_socket'>tcp_pipeline_socket</span><span class='lparen'>(</span><span class='id identifier rubyid_src_port'>src_port</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_src_port'>src_port</span> <span class='op'>=</span> <span class='ivar'>@tcp_pipeline_local_port</span>
          <span class='kw'>else</span>
            <span class='id identifier rubyid_socket'>socket</span> <span class='op'>=</span> <span class='const'>Socket</span><span class='period'>.</span><span class='id identifier rubyid_tcp'>tcp</span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='comma'>,</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='id identifier rubyid_src_address'>src_address</span><span class='comma'>,</span> <span class='id identifier rubyid_src_port'>src_port</span><span class='comma'>,</span> <span class='label'>connect_timeout:</span> <span class='ivar'>@packet_timeout</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_new_socket'>new_socket</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='kw'>end</span>
        <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EBADF</span><span class='comma'>,</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENETUNREACH</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
          <span class='comment'>#  Can&#39;t create a connection
</span>          <span class='id identifier rubyid_err'>err</span><span class='op'>=</span><span class='const'>IOError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TCP connection error to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@port</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_address'>src_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_port'>src_port</span><span class='embexpr_end'>}</span><span class='tstring_content'>, use_tcp=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='embexpr_end'>}</span><span class='tstring_content'>, exception = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
          <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
          <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
          <span class='kw'>return</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_socket'>socket</span> <span class='op'>=</span> <span class='kw'>nil</span>
        <span class='comment'>#  JRuby UDPSocket only takes 0 parameters - no IPv6 support in JRuby...
</span>        <span class='kw'>if</span> <span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>java</span><span class='regexp_end'>/</span></span> <span class='op'>=~</span> <span class='const'>RUBY_PLATFORM</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_socket'>socket</span> <span class='op'>=</span> <span class='const'>UDPSocket</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='comment'>#               ipv6 = @src_address =~ /:/
</span>          <span class='id identifier rubyid_socket'>socket</span> <span class='op'>=</span> <span class='const'>UDPSocket</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@ipv6</span> <span class='op'>?</span> <span class='const'>Socket</span><span class='op'>::</span><span class='const'>AF_INET6</span> <span class='op'>:</span> <span class='const'>Socket</span><span class='op'>::</span><span class='const'>AF_INET</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_new_socket'>new_socket</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_bind'>bind</span><span class='lparen'>(</span><span class='id identifier rubyid_src_address'>src_address</span><span class='comma'>,</span> <span class='id identifier rubyid_src_port'>src_port</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span><span class='lparen'>(</span><span class='ivar'>@server</span><span class='comma'>,</span> <span class='ivar'>@port</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_runnextportloop'>runnextportloop</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_socket'>socket</span><span class='op'>!=</span><span class='kw'>nil</span><span class='rparen'>)</span>
        <span class='kw'>begin</span>
          <span class='comment'>#let the select thread close the socket if tcp_pipeli
</span>          <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span> <span class='kw'>unless</span> <span class='ivar'>@tcp_pipelining</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_new_socket'>new_socket</span>
        <span class='kw'>rescue</span> <span class='const'>Exception</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='comment'>#  Try again if the error was EADDRINUSE and a random source port is used
</span>      <span class='comment'>#  Maybe try a max number of times?
</span>      <span class='kw'>if</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span> <span class='op'>!=</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EADDRINUSE</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_numtries'>numtries</span> <span class='op'>&gt;</span> <span class='int'>50</span><span class='rparen'>)</span> <span class='op'>||</span>
          <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span> <span class='op'>==</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EADDRINUSE</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_src_port'>src_port</span> <span class='op'>==</span> <span class='ivar'>@src_port</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_err_msg'>err_msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dnsruby can&#39;t connect to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@port</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_address'>src_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_port'>src_port</span><span class='embexpr_end'>}</span><span class='tstring_content'>, use_tcp=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='embexpr_end'>}</span><span class='tstring_content'>, exception = </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='id identifier rubyid_err'>err</span><span class='op'>=</span><span class='const'>IOError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_err_msg'>err_msg</span><span class='rparen'>)</span>
        <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='ivar'>@tcp_pipelining</span>
          <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="SocketEofResolvError.html" title="Dnsruby::SocketEofResolvError (class)">SocketEofResolvError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_err_msg'>err_msg</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='kw'>return</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_socket'>socket</span><span class='op'>==</span><span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_err'>err</span><span class='op'>=</span><span class='const'>IOError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dnsruby can&#39;t connect to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@port</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_address'>src_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_port'>src_port</span><span class='embexpr_end'>}</span><span class='tstring_content'>, use_tcp=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>
  <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sending packet to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@port</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_address'>src_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_port'>src_port</span><span class='embexpr_end'>}</span><span class='tstring_content'>, use_tcp=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='embexpr_end'>}</span><span class='tstring_content'> : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qtype'>qtype</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='comment'>#             print &quot;#{Time.now} : Sending packet to #{@server} : #{query.question()[0].qname}, #{query.question()[0].qtype}\n&quot;
</span>  <span class='comment'>#  Listen for the response before we send the packet (to avoid any race conditions)
</span>  <span class='id identifier rubyid_query_settings'>query_settings</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="SelectThread.html" title="Dnsruby::SelectThread (class)">SelectThread</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="SelectThread/QuerySettings.html" title="Dnsruby::SelectThread::QuerySettings (class)">QuerySettings</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="SelectThread/QuerySettings.html#initialize-instance_method" title="Dnsruby::SelectThread::QuerySettings#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_query_bytes'>query_bytes</span><span class='comma'>,</span> <span class='id identifier rubyid_query'>query</span><span class='comma'>,</span> <span class='ivar'>@ignore_truncation</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_socket'>socket</span><span class='comma'>,</span> <span class='ivar'>@server</span><span class='comma'>,</span> <span class='ivar'>@port</span><span class='comma'>,</span> <span class='id identifier rubyid_endtime'>endtime</span><span class='comma'>,</span> <span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_query_settings'>query_settings</span><span class='period'>.</span><span class='id identifier rubyid_is_persistent_socket'>is_persistent_socket</span> <span class='op'>=</span> <span class='ivar'>@tcp_pipelining</span> <span class='kw'>if</span> <span class='id identifier rubyid_use_tcp'>use_tcp</span>
  <span class='id identifier rubyid_query_settings'>query_settings</span><span class='period'>.</span><span class='id identifier rubyid_tcp_pipelining_max_queries'>tcp_pipelining_max_queries</span> <span class='op'>=</span> <span class='ivar'>@tcp_pipelining_max_queries</span> <span class='kw'>if</span> <span class='ivar'>@tcp_pipelining</span>
  <span class='kw'>begin</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_lenmsg'>lenmsg</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_query_bytes'>query_bytes</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>n</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_lenmsg'>lenmsg</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_query_bytes'>query_bytes</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>

    <span class='comment'>#  The select thread will now wait for the response and send that or a
</span>    <span class='comment'>#  timeout back to the client_queue.
</span>    <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_add_to_select'>add_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_query_settings'>query_settings</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_err_msg'>err_msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Send failed to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@port</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_address'>src_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_port'>src_port</span><span class='embexpr_end'>}</span><span class='tstring_content'>, use_tcp=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='embexpr_end'>}</span><span class='tstring_content'>, exception : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_err'>err</span><span class='op'>=</span><span class='const'>IOError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_err_msg'>err_msg</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='ivar'>@tcp_pipelining</span>
      <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="SocketEofResolvError.html" title="Dnsruby::SocketEofResolvError (class)">SocketEofResolvError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_err_msg'>err_msg</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_new_socket'>new_socket</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_push_exception_to_select'>push_exception_to_select</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='kw'>begin</span>
      <span class='comment'>#we let the select_thread close the socket when doing tcp
</span>      <span class='comment'>#pipelining
</span>      <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span> <span class='kw'>unless</span> <span class='ivar'>@tcp_pipelining</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_new_socket'>new_socket</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Packet sent to </span><span class='embexpr_beg'>#{</span><span class='ivar'>@server</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='ivar'>@port</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_address'>src_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_port'>src_port</span><span class='embexpr_end'>}</span><span class='tstring_content'>, use_tcp=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_use_tcp'>use_tcp</span><span class='embexpr_end'>}</span><span class='tstring_content'> : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qname'>qname</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_question'>question</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_qtype'>qtype</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='comment'>#       print &quot;Packet sent to #{@server}:#{@port} from #{@src_address}:#{src_port}, use_tcp=#{use_tcp} : #{query.question()[0].qname}, #{query.question()[0].qtype}\n&quot;
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="src_address6=-instance_method">
  
    #<strong>src_address6=</strong>(arg)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Set the source address. If the arg is nil, do nothing</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


125
126
127
128
129</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 125</span>

<span class='kw'>def</span> <span class='id identifier rubyid_src_address6='>src_address6=</span><span class='lparen'>(</span><span class='id identifier rubyid_arg'>arg</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='kw'>not</span> <span class='id identifier rubyid_arg'>arg</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span><span class='rparen'>)</span>
    <span class='ivar'>@src_address6</span> <span class='op'>=</span> <span class='id identifier rubyid_arg'>arg</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="src_port-instance_method">
  
    #<strong>src_port</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The source port to send queries from</p>

<pre class="code ruby"><code class="ruby">Returns either a single Integer or an Array
e.g. &quot;0&quot;, or &quot;[60001, 60002, 60007]&quot;

Defaults to 0 - random port
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


558
559
560
561
562
563</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 558</span>

<span class='kw'>def</span> <span class='id identifier rubyid_src_port'>src_port</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@src_port</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>1</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='ivar'>@src_port</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='ivar'>@src_port</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="src_port=-instance_method">
  
    #<strong>src_port=</strong>(p)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Can be a single Integer or a Range or an Array</p>

<pre class="code ruby"><code class="ruby">If an invalid port is selected (one reserved by
IANA), then an ArgumentError will be raised.

       res.src_port=0
       res.src_port=[60001,60005,60010]
       res.src_port=60015..60115
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


573
574
575
576</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 573</span>

<span class='kw'>def</span> <span class='id identifier rubyid_src_port='>src_port=</span><span class='lparen'>(</span><span class='id identifier rubyid_p'>p</span><span class='rparen'>)</span>
  <span class='ivar'>@src_port</span><span class='op'>=</span><span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_add_src_port'>add_src_port</span><span class='lparen'>(</span><span class='id identifier rubyid_p'>p</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="tcp_pipeline_socket-instance_method">
  
    #<strong>tcp_pipeline_socket</strong>(src_port)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method returns the current tcp socket for pipelining</p>

<pre class="code ruby"><code class="ruby">If this is the first time the method is called then the socket is bound to
@src_address:@src_port and connected to the remote dns server @server:@port.
If the connection has been closed because of an EOF on recv_nonblock (closed by server)
the function will recreate of the socket (since @pipeline_socket.connect will result in a IOError
exception)
In general, every subsequent call the function will either return the current tcp
pipeline socket or a new connected socket if the current one was closed by the server
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 387</span>

<span class='kw'>def</span> <span class='id identifier rubyid_tcp_pipeline_socket'>tcp_pipeline_socket</span><span class='lparen'>(</span><span class='id identifier rubyid_src_port'>src_port</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Using tcp_pipeline_socket</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_sockaddr'>sockaddr</span> <span class='op'>=</span> <span class='const'>Socket</span><span class='period'>.</span><span class='id identifier rubyid_sockaddr_in'>sockaddr_in</span><span class='lparen'>(</span><span class='ivar'>@port</span><span class='comma'>,</span> <span class='ivar'>@server</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_reuse_pipeline_socket'>reuse_pipeline_socket</span> <span class='op'>=</span> <span class='tlambda'>-&gt;</span> <span class='kw'>do</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_max'>max</span> <span class='op'>=</span> <span class='ivar'>@tcp_pipelining_max_queries</span>
      <span class='id identifier rubyid_use_count'>use_count</span> <span class='op'>=</span> <span class='ivar'>@use_counts</span><span class='lbracket'>[</span><span class='ivar'>@pipeline_socket</span><span class='rbracket'>]</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_use_count'>use_count</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_max'>max</span> <span class='op'>!=</span> <span class='symbol'>:infinite</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_use_count'>use_count</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_max'>max</span>
         <span class='comment'>#we can&#39;t reuse the socket since max is reached
</span>        <span class='ivar'>@use_counts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='ivar'>@pipeline_socket</span><span class='rparen'>)</span>
        <span class='ivar'>@pipeline_socket</span> <span class='op'>=</span> <span class='kw'>nil</span>
        <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Max queries per connection attained - creating new socket</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='ivar'>@pipeline_socket</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span><span class='lparen'>(</span><span class='id identifier rubyid_sockaddr'>sockaddr</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EISCONN</span>
      <span class='comment'>#already connected, do nothing and reuse!
</span>    <span class='kw'>rescue</span> <span class='const'>IOError</span><span class='comma'>,</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ECONNRESET</span> <span class='comment'>#close by remote host, reconnect
</span>      <span class='ivar'>@pipeline_socket</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Connection closed - recreating socket</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_create_pipeline_socket'>create_pipeline_socket</span> <span class='op'>=</span> <span class='tlambda'>-&gt;</span> <span class='kw'>do</span>
    <span class='ivar'>@tcp_pipeline_local_port</span> <span class='op'>=</span> <span class='id identifier rubyid_src_port'>src_port</span>
    <span class='id identifier rubyid_src_address'>src_address</span> <span class='op'>=</span> <span class='ivar'>@ipv6</span> <span class='op'>?</span> <span class='ivar'>@src_address6</span> <span class='op'>:</span> <span class='ivar'>@src_address</span>
    <span class='kw'>begin</span>
      <span class='ivar'>@pipeline_socket</span> <span class='op'>=</span> <span class='const'>Socket</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>Socket</span><span class='op'>::</span><span class='const'>AF_INET</span><span class='comma'>,</span> <span class='const'>Socket</span><span class='op'>::</span><span class='const'>SOCK_STREAM</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
      <span class='ivar'>@pipeline_socket</span><span class='period'>.</span><span class='id identifier rubyid_bind'>bind</span><span class='lparen'>(</span><span class='const'>Addrinfo</span><span class='period'>.</span><span class='id identifier rubyid_tcp'>tcp</span><span class='lparen'>(</span><span class='id identifier rubyid_src_address'>src_address</span><span class='comma'>,</span> <span class='id identifier rubyid_src_port'>src_port</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='ivar'>@pipeline_socket</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span><span class='lparen'>(</span><span class='id identifier rubyid_sockaddr'>sockaddr</span><span class='rparen'>)</span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Creating socket </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_address'>src_address</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_src_port'>src_port</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='ivar'>@use_counts</span><span class='lbracket'>[</span><span class='ivar'>@pipeline_socket</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='ivar'>@pipeline_socket</span> <span class='op'>=</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Don&#39;t combine the following 2 statements; the reuse lambda can set the
</span>  <span class='comment'># socket to nil and if so we&#39;d want to call the create lambda to recreate it.
</span>  <span class='id identifier rubyid_reuse_pipeline_socket'>reuse_pipeline_socket</span><span class='period'>.</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@pipeline_socket</span>
  <span class='id identifier rubyid_new_socket'>new_socket</span> <span class='op'>=</span> <span class='ivar'>@pipeline_socket</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_create_pipeline_socket'>create_pipeline_socket</span><span class='period'>.</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@pipeline_socket</span>

  <span class='ivar'>@use_counts</span><span class='lbracket'>[</span><span class='ivar'>@pipeline_socket</span><span class='rbracket'>]</span> <span class='op'>+=</span> <span class='int'>1</span>

  <span class='lbracket'>[</span><span class='ivar'>@pipeline_socket</span><span class='comma'>,</span> <span class='id identifier rubyid_new_socket'>new_socket</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="udp_packet_size-instance_method">
  
    #<strong>udp_packet_size</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the packet size to use for UDP</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


769
770
771
772
773
774</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/packet_sender.rb', line 769</span>

<span class='kw'>def</span> <span class='id identifier rubyid_udp_packet_size'>udp_packet_size</span>
  <span class='comment'>#  if @udp_size &gt; DefaultUDPSize then we use EDNS and
</span>  <span class='comment'>#  @udp_size should be taken as the maximum packet_data length
</span>  <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='ivar'>@udp_size</span> <span class='op'>&gt;</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver.html#DefaultUDPSize-constant" title="Dnsruby::Resolver::DefaultUDPSize (constant)">DefaultUDPSize</a></span></span> <span class='op'>?</span> <span class='ivar'>@udp_size</span> <span class='op'>:</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver.html#DefaultUDPSize-constant" title="Dnsruby::Resolver::DefaultUDPSize (constant)">DefaultUDPSize</a></span></span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_ret'>ret</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Apr  9 10:58:17 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-3.0.0).
</div>

    </div>
  </body>
</html>