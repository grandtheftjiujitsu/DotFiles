<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Dnsruby::ResolverRuby
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Dnsruby::ResolverRuby";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (R)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span>
     &raquo; 
    <span class="title">ResolverRuby</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Dnsruby::ResolverRuby
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Dnsruby::ResolverRuby</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/dnsruby/resolver.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This class implements the I/O using pure Ruby, with no dependencies.</p>

<pre class="code ruby"><code class="ruby">Support for EventMachine has been deprecated.
</code></pre>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#close-instance_method" title="#close (instance method)">#<strong>close</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Close the Resolver.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#decrement_resolver_priority-instance_method" title="#decrement_resolver_priority (instance method)">#<strong>decrement_resolver_priority</strong>(res)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>TO BE CALLED IN A SYNCHRONIZED BLOCK.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#demote_resolver-instance_method" title="#demote_resolver (instance method)">#<strong>demote_resolver</strong>(res)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>TO BE CALLED IN A SYNCHRONIZED BLOCK.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_timeouts-instance_method" title="#generate_timeouts (instance method)">#<strong>generate_timeouts</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc: all.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#handle_error_response-instance_method" title="#handle_error_response (instance method)">#<strong>handle_error_response</strong>(select_queue, query_id, error, response)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc: all.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#handle_queue_event-instance_method" title="#handle_queue_event (instance method)">#<strong>handle_queue_event</strong>(queue, id)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method is called by the SelectThread (in the select thread) when the queue has a new item on it.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#handle_response-instance_method" title="#handle_response (instance method)">#<strong>handle_response</strong>(select_queue, query_id, response)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc: all.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#handle_validation_error-instance_method" title="#handle_validation_error (instance method)">#<strong>handle_validation_error</strong>(select_queue, query_id, error, response)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#handle_validation_response-instance_method" title="#handle_validation_response (instance method)">#<strong>handle_validation_response</strong>(select_queue, query_id, response)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc: all.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#increment_resolver_priority-instance_method" title="#increment_resolver_priority (instance method)">#<strong>increment_resolver_priority</strong>(res)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>TO BE CALLED IN A SYNCHRONIZED BLOCK.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(parent)  &#x21d2; ResolverRuby </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc: all.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset_attributes-instance_method" title="#reset_attributes (instance method)">#<strong>reset_attributes</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc: all.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_async-instance_method" title="#send_async (instance method)">#<strong>send_async</strong>(msg, client_queue, client_query_id = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_result-instance_method" title="#send_result (instance method)">#<strong>send_result</strong>(client_queue, client_query_id, select_queue, msg, error)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>MUST BE CALLED IN A SYNCHRONIZED BLOCK!.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_result_and_stop_querying-instance_method" title="#send_result_and_stop_querying (instance method)">#<strong>send_result_and_stop_querying</strong>(client_queue, client_query_id, select_queue, msg, error)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>MUST BE CALLED IN A SYNCHRONIZED BLOCK!.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stop_querying-instance_method" title="#stop_querying (instance method)">#<strong>stop_querying</strong>(client_query_id)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>MUST BE CALLED IN A SYNCHRONIZED BLOCK!.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#tick-instance_method" title="#tick (instance method)">#<strong>tick</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method is called twice a second from the select loop, in the select thread.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(parent)  &#x21d2; <tt><span class='object_link'><a href="" title="Dnsruby::ResolverRuby (class)">ResolverRuby</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: all</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


855
856
857
858</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 855</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_parent'>parent</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_reset_attributes'>reset_attributes</span>
  <span class='ivar'>@parent</span><span class='op'>=</span><span class='id identifier rubyid_parent'>parent</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="close-instance_method">
  
    #<strong>close</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Close the Resolver. Unfinished queries are terminated with OtherResolvError.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


941
942
943
944
945
946
947
948
949
950</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 941</span>

<span class='kw'>def</span> <span class='id identifier rubyid_close'>close</span>
  <span class='comment'>#       @mutex.synchronize {
</span>  <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_res_mutex'>single_res_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='ivar'>@query_list</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='op'>|</span>
     <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_q'>q</span><span class='comma'>,</span> <span class='id identifier rubyid__outstanding'>_outstanding</span> <span class='op'>=</span> <span class='id identifier rubyid_values'>values</span>
      <span class='id identifier rubyid_send_result_and_stop_querying'>send_result_and_stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_q'>q</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span>
          <span class='const'><span class='object_link'><a href="OtherResolvError.html" title="Dnsruby::OtherResolvError (class)">OtherResolvError</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Resolver closing!</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="decrement_resolver_priority-instance_method">
  
    #<strong>decrement_resolver_priority</strong>(res)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>TO BE CALLED IN A SYNCHRONIZED BLOCK</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1182
1183
1184
1185
1186
1187
1188
1189
1190
1191</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1182</span>

<span class='kw'>def</span> <span class='id identifier rubyid_decrement_resolver_priority'>decrement_resolver_priority</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="TheLog.html" title="Dnsruby::TheLog (class)">TheLog</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Decrementing resolver priority for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='comment'>#       @parent.single_res_mutex.synchronize {
</span>  <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_index'>index</span> <span class='op'>&lt;</span> <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
    <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
    <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_insert'>insert</span><span class='lparen'>(</span><span class='id identifier rubyid_index'>index</span><span class='op'>+</span><span class='int'>1</span><span class='comma'>,</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='comment'>#       }
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="demote_resolver-instance_method">
  
    #<strong>demote_resolver</strong>(res)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>TO BE CALLED IN A SYNCHRONIZED BLOCK</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1194
1195
1196
1197
1198
1199
1200</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1194</span>

<span class='kw'>def</span> <span class='id identifier rubyid_demote_resolver'>demote_resolver</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="TheLog.html" title="Dnsruby::TheLog (class)">TheLog</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Demoting resolver priority for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='embexpr_end'>}</span><span class='tstring_content'> to bottom\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='comment'>#       @parent.single_res_mutex.synchronize {
</span>  <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='comment'>#       }
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_timeouts-instance_method">
  
    #<strong>generate_timeouts</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: all</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


931
932
933
934
935
936
937
938</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 931</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_timeouts'>generate_timeouts</span> <span class='comment'># :nodoc: all
</span>  <span class='comment'>#  Create the timeouts for the query from the retry_times and retry_delay attributes.
</span>  <span class='comment'>#  These are created at the same time in case the parameters change during the life of the query.
</span>  <span class='comment'>#
</span>  <span class='comment'>#  These should be absolute, rather than relative
</span>  <span class='comment'>#  The first value should be Time.now[
</span>  <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_generate_timeouts'>generate_timeouts</span><span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handle_error_response-instance_method">
  
    #<strong>handle_error_response</strong>(select_queue, query_id, error, response)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: all</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1110</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_error_response'>handle_error_response</span><span class='lparen'>(</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_query_id'>query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='comment'># :nodoc: all
</span>  <span class='comment'>#  Handle an error
</span>  <span class='comment'>#       @mutex.synchronize{
</span>  <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>handling error </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_error'>error</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='comment'>#  Check what sort of error it was :
</span>  <span class='id identifier rubyid_resolver'>resolver</span><span class='comma'>,</span> <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid__retry_count'>_retry_count</span> <span class='op'>=</span> <span class='id identifier rubyid_query_id'>query_id</span>
  <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_outstanding'>outstanding</span> <span class='op'>=</span> <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="ResolvTimeout.html" title="Dnsruby::ResolvTimeout (class)">ResolvTimeout</a></span></span><span class='rparen'>)</span>
    <span class='comment'>#    - if it was a timeout, then check which number it was, and how many retries are expected on that server
</span>    <span class='comment'>#        - if it was the last retry, on the last server, then return a timeout to the client (and clean up)
</span>    <span class='comment'>#        - otherwise, continue
</span>    <span class='comment'>#  Do we have any more packets to send to this resolver?
</span>
    <span class='id identifier rubyid_decrement_resolver_priority'>decrement_resolver_priority</span><span class='lparen'>(</span><span class='id identifier rubyid_resolver'>resolver</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_timeouts'>timeouts</span> <span class='op'>=</span> <span class='ivar'>@timeouts</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_outstanding'>outstanding</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_timeouts'>timeouts</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_timeouts'>timeouts</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Sending timeout to client</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_send_result_and_stop_querying'>send_result_and_stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="NXDomain.html" title="Dnsruby::NXDomain (class)">NXDomain</a></span></span><span class='rparen'>)</span>
    <span class='comment'>#    - if it was an NXDomain, then return that to the client, and stop all new queries (and clean up)
</span>    <span class='comment'>#         send_result_and_stop_querying(client_queue, client_query_id, select_queue, response, error)
</span>    <span class='id identifier rubyid_increment_resolver_priority'>increment_resolver_priority</span><span class='lparen'>(</span><span class='id identifier rubyid_resolver'>resolver</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_cached'>cached</span>
    <span class='id identifier rubyid_stop_querying'>stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>
    <span class='comment'>#  @TODO@ Does the client want notified at this point?
</span>  <span class='kw'>elsif</span> <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="EncodeError.html" title="Dnsruby::EncodeError (class)">EncodeError</a></span></span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Encode error - sending to client</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span>
    <span class='id identifier rubyid_send_result_and_stop_querying'>send_result_and_stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='comment'>#    - if it was any other error, then remove that server from the list for that query
</span>    <span class='comment'>#    If a Too Many Open Files error, then don&#39;t remove, but let retry work.
</span>    <span class='id identifier rubyid_timeouts'>timeouts</span> <span class='op'>=</span> <span class='ivar'>@timeouts</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>Errno::EMFILE</span><span class='regexp_end'>/</span></span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Removing </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resolver'>resolver</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='embexpr_end'>}</span><span class='tstring_content'> from resolver list for this query</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_timeouts'>timeouts</span>
        <span class='id identifier rubyid_timeouts'>timeouts</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
          <span class='id identifier rubyid_res'>res</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_res'>res</span> <span class='op'>==</span> <span class='id identifier rubyid_resolver'>resolver</span>
            <span class='id identifier rubyid_timeouts'>timeouts</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='comment'>#  Also stick it to the back of the list for future queries
</span>      <span class='id identifier rubyid_demote_resolver'>demote_resolver</span><span class='lparen'>(</span><span class='id identifier rubyid_resolver'>resolver</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>NOT Removing </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_resolver'>resolver</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='embexpr_end'>}</span><span class='tstring_content'> due to Errno::EMFILE</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='comment'>#         - if it was the last server, then return an error to the client (and clean up)
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_outstanding'>outstanding</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_timeouts'>timeouts</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_timeouts'>timeouts</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_timeouts'>timeouts</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='comment'>#           if outstanding.empty?
</span>      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Sending error to client</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span>
      <span class='id identifier rubyid_send_result_and_stop_querying'>send_result_and_stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'>#  @TODO@ If we&#39;re still sending packets for this query, but none are outstanding, then
</span>  <span class='comment'>#  jumpstart the next query?
</span>  <span class='comment'>#       }
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handle_queue_event-instance_method">
  
    #<strong>handle_queue_event</strong>(queue, id)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method is called by the SelectThread (in the select thread) when the queue has a new item on it.</p>

<pre class="code ruby"><code class="ruby">The queue interface is used to separate producer/consumer threads, but we&#39;re using it here in one thread.
It&#39;s probably a good idea to create a new &quot;worker thread&quot; to take items from the select thread queue and
call this method in the worker thread.
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1033</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_queue_event'>handle_queue_event</span><span class='lparen'>(</span><span class='id identifier rubyid_queue'>queue</span><span class='comma'>,</span> <span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span> <span class='comment'># :nodoc: all
</span>  <span class='comment'>#  Time to process a new queue event.
</span>  <span class='comment'>#  If we get a callback for an ID we don&#39;t know about, don&#39;t worry -
</span>  <span class='comment'>#  just ignore it. It may be for a query we&#39;ve already completed.
</span>  <span class='comment'>#
</span>  <span class='comment'>#  So, get the next response from the queue (presuming there is one!)
</span>  <span class='comment'>#
</span>  <span class='comment'>#  @TODO@ Tick could poll the queue and then call this method if needed - no need for observer interface.
</span>  <span class='comment'>#  @TODO@ Currently, tick and handle_queue_event called from select_thread - could have thread chuck events in to tick_queue. But then, clients would have to call in on other thread!
</span>  <span class='comment'>#
</span>  <span class='comment'>#  So - two types of response :
</span>  <span class='comment'>#  1) we&#39;ve got a coherent response (or error) - stop sending more packets for that query!
</span>  <span class='comment'>#  2) we&#39;ve validated the response - it&#39;s ready to be sent to the client
</span>  <span class='comment'>#
</span>  <span class='comment'>#  so need two more methods :
</span>  <span class='comment'>#   handleValidationResponse : basically calls send_result_and_stop_querying and
</span>  <span class='comment'>#   handleValidationError : does the same as handleValidationResponse, but for errors
</span>  <span class='comment'>#  can leave handleError alone
</span>  <span class='comment'>#  but need to change handleResponse to stop sending, rather than send_result_and_stop_querying.
</span>  <span class='comment'>#
</span>  <span class='comment'>#  @TODO@ Also, we could really do with a MaxValidationTimeout - if validation not OK within
</span>  <span class='comment'>#  this time, then raise Timeout (and stop validation)?
</span>  <span class='comment'>#
</span>  <span class='comment'>#  @TODO@ Also, should there be some facility to stop validator following same chain
</span>  <span class='comment'>#  concurrently?
</span>  <span class='comment'>#
</span>  <span class='comment'>#  @TODO@ Also, should have option to speak only to configured resolvers (not follow authoritative chain)
</span>  <span class='comment'>#
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_queue'>queue</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_log_and_raise'>log_and_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Severe internal error - Queue empty in handle_queue_event</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_event_id'>event_id</span><span class='comma'>,</span> <span class='id identifier rubyid_event_type'>event_type</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span> <span class='op'>=</span> <span class='id identifier rubyid_queue'>queue</span><span class='period'>.</span><span class='id identifier rubyid_pop'>pop</span>
  <span class='comment'>#  We should remove this packet from the list of outstanding packets for this query
</span>  <span class='id identifier rubyid__resolver'>_resolver</span><span class='comma'>,</span> <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid__retry_count'>_retry_count</span> <span class='op'>=</span> <span class='id identifier rubyid_id'>id</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_id'>id</span> <span class='op'>!=</span> <span class='id identifier rubyid_event_id'>event_id</span>
    <span class='id identifier rubyid_log_and_raise'>log_and_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Serious internal error!! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> expected, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event_id'>event_id</span><span class='embexpr_end'>}</span><span class='tstring_content'> received</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='comment'>#       @mutex.synchronize{
</span>  <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_res_mutex'>single_res_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='kw'>if</span> <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span>
      <span class='comment'>#           print &quot;Dead query response - ignoring\n&quot;
</span>      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Ignoring response for dead query</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid__client_queue'>_client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid__select_queue'>_select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_outstanding'>outstanding</span> <span class='op'>=</span> <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_event_type'>event_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html" title="Dnsruby::Resolver::EventType (class)">EventType</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html#RECEIVED-constant" title="Dnsruby::Resolver::EventType::RECEIVED (constant)">RECEIVED</a></span></span> <span class='op'>||</span>
          <span class='id identifier rubyid_event_type'>event_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html" title="Dnsruby::Resolver::EventType (class)">EventType</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html#ERROR-constant" title="Dnsruby::Resolver::EventType::ERROR (constant)">ERROR</a></span></span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_outstanding'>outstanding</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_log_and_raise'>log_and_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Query id not on outstanding list! </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_outstanding'>outstanding</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> items. </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'> not on </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_outstanding'>outstanding</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_outstanding'>outstanding</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='comment'>#       }
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_event_type'>event_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html" title="Dnsruby::Resolver::EventType (class)">EventType</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html#RECEIVED-constant" title="Dnsruby::Resolver::EventType::RECEIVED (constant)">RECEIVED</a></span></span>
      <span class='comment'>#       if (event.kind_of?(Exception))
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_error'>error</span>
        <span class='id identifier rubyid_handle_error_response'>handle_error_response</span><span class='lparen'>(</span><span class='id identifier rubyid_queue'>queue</span><span class='comma'>,</span> <span class='id identifier rubyid_event_id'>event_id</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='kw'>else</span> <span class='comment'># if event.kind_of?(Message)
</span>        <span class='id identifier rubyid_handle_response'>handle_response</span><span class='lparen'>(</span><span class='id identifier rubyid_queue'>queue</span><span class='comma'>,</span> <span class='id identifier rubyid_event_id'>event_id</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
        <span class='comment'>#       else
</span>        <span class='comment'>#         Dnsruby.log.error(&#39;Random object #{event.class} returned through queue to Resolver&#39;)
</span>      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_event_type'>event_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html" title="Dnsruby::Resolver::EventType (class)">EventType</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html#VALIDATED-constant" title="Dnsruby::Resolver::EventType::VALIDATED (constant)">VALIDATED</a></span></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_error'>error</span>
        <span class='id identifier rubyid_handle_validation_error'>handle_validation_error</span><span class='lparen'>(</span><span class='id identifier rubyid_queue'>queue</span><span class='comma'>,</span> <span class='id identifier rubyid_event_id'>event_id</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_handle_validation_response'>handle_validation_response</span><span class='lparen'>(</span><span class='id identifier rubyid_queue'>queue</span><span class='comma'>,</span> <span class='id identifier rubyid_event_id'>event_id</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_event_type'>event_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Resolver.html" title="Dnsruby::Resolver (class)">Resolver</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html" title="Dnsruby::Resolver::EventType (class)">EventType</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Resolver/EventType.html#ERROR-constant" title="Dnsruby::Resolver::EventType::ERROR (constant)">ERROR</a></span></span>
      <span class='id identifier rubyid_handle_error_response'>handle_error_response</span><span class='lparen'>(</span><span class='id identifier rubyid_queue'>queue</span><span class='comma'>,</span> <span class='id identifier rubyid_event_id'>event_id</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='comment'>#           print &quot;ERROR - UNKNOWN EVENT TYPE IN RESOLVER : #{event_type}\n&quot;
</span>      <span class='const'><span class='object_link'><a href="TheLog.html" title="Dnsruby::TheLog (class)">TheLog</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ERROR - UNKNOWN EVENT TYPE IN RESOLVER : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_event_type'>event_type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handle_response-instance_method">
  
    #<strong>handle_response</strong>(select_queue, query_id, response)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: all</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1202</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_response'>handle_response</span><span class='lparen'>(</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_query_id'>query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='comment'># :nodoc: all
</span>  <span class='comment'>#  Handle a good response
</span>  <span class='comment'>#  Should also stick resolver more to the front of the list for future queries
</span>  <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Handling good response</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_resolver'>resolver</span><span class='comma'>,</span> <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid__retry_count'>_retry_count</span> <span class='op'>=</span> <span class='id identifier rubyid_query_id'>query_id</span>
  <span class='id identifier rubyid_increment_resolver_priority'>increment_resolver_priority</span><span class='lparen'>(</span><span class='id identifier rubyid_resolver'>resolver</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_cached'>cached</span>
  <span class='comment'>#       @mutex.synchronize{
</span>  <span class='id identifier rubyid__query'>_query</span><span class='comma'>,</span> <span class='id identifier rubyid__client_queue'>_client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_s_queue'>s_queue</span><span class='comma'>,</span> <span class='id identifier rubyid__outstanding'>_outstanding</span> <span class='op'>=</span> <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_s_queue'>s_queue</span> <span class='op'>!=</span> <span class='id identifier rubyid_select_queue'>select_queue</span>
    <span class='id identifier rubyid_log_and_raise'>log_and_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Serious internal error : expected select queue </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_s_queue'>s_queue</span><span class='embexpr_end'>}</span><span class='tstring_content'>, got </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_stop_querying'>stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>
  <span class='comment'>#  @TODO@ Does the client want notified at this point?
</span>  <span class='comment'>#         client_queue.push([client_query_id, Resolver::EventType::RECEIVED, msg, nil])
</span>  <span class='comment'>#       }
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handle_validation_error-instance_method">
  
    #<strong>handle_validation_error</strong>(select_queue, query_id, error, response)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246
1247
1248
1249</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1236</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_validation_error'>handle_validation_error</span><span class='lparen'>(</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_query_id'>query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span>
  <span class='id identifier rubyid__resolver'>_resolver</span><span class='comma'>,</span> <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid__retry_count'>_retry_count</span> <span class='op'>=</span> <span class='id identifier rubyid_query_id'>query_id</span>
  <span class='id identifier rubyid__query'>_query</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_s_queue'>s_queue</span><span class='comma'>,</span> <span class='id identifier rubyid__outstanding'>_outstanding</span> <span class='op'>=</span> <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_s_queue'>s_queue</span> <span class='op'>!=</span> <span class='id identifier rubyid_select_queue'>select_queue</span>
    <span class='id identifier rubyid_log_and_raise'>log_and_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Serious internal error : expected select queue </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_s_queue'>s_queue</span><span class='embexpr_end'>}</span><span class='tstring_content'>, got </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='comment'>#       For some errors, we immediately send result. For others, should we retry?
</span>  <span class='comment'>#       Either :
</span>  <span class='comment'>#                 handle_error_response(queue, event_id, error, response)
</span>  <span class='comment'>#                 Or:
</span>  <span class='id identifier rubyid_send_result'>send_result</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span>
  <span class='comment'>#
</span>  <span class='comment'>#
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handle_validation_response-instance_method">
  
    #<strong>handle_validation_response</strong>(select_queue, query_id, response)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: all</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1219</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handle_validation_response'>handle_validation_response</span><span class='lparen'>(</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_query_id'>query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='comment'># :nodoc: all
</span>  <span class='id identifier rubyid__resolver'>_resolver</span><span class='comma'>,</span> <span class='id identifier rubyid__msg'>_msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid__retry_count'>_retry_count</span> <span class='op'>=</span> <span class='id identifier rubyid_query_id'>query_id</span>
  <span class='comment'>#       @mutex.synchronize {
</span>  <span class='id identifier rubyid__query'>_query</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_s_queue'>s_queue</span><span class='comma'>,</span> <span class='id identifier rubyid__outstanding'>_outstanding</span> <span class='op'>=</span> <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_s_queue'>s_queue</span> <span class='op'>!=</span> <span class='id identifier rubyid_select_queue'>select_queue</span>
    <span class='id identifier rubyid_log_and_raise'>log_and_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Serious internal error : expected select queue </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_s_queue'>s_queue</span><span class='embexpr_end'>}</span><span class='tstring_content'>, got </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_rcode'>rcode</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="RCode.html" title="Dnsruby::RCode (class)">RCode</a></span></span><span class='period'>.</span><span class='const'>NXDOMAIN</span>
    <span class='id identifier rubyid_send_result'>send_result</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="NXDomain.html" title="Dnsruby::NXDomain (class)">NXDomain</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='comment'>#  @TODO@ Was there an error validating? Should we raise an exception for certain security levels?
</span>    <span class='comment'>#  This should be configurable by the client.
</span>    <span class='id identifier rubyid_send_result'>send_result</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='comment'>#       }
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="increment_resolver_priority-instance_method">
  
    #<strong>increment_resolver_priority</strong>(res)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>TO BE CALLED IN A SYNCHRONIZED BLOCK</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1170
1171
1172
1173
1174
1175
1176
1177
1178
1179</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 1170</span>

<span class='kw'>def</span> <span class='id identifier rubyid_increment_resolver_priority'>increment_resolver_priority</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="TheLog.html" title="Dnsruby::TheLog (class)">TheLog</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Incrementing resolver priority for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='comment'>#       @parent.single_res_mutex.synchronize {
</span>  <span class='id identifier rubyid_index'>index</span> <span class='op'>=</span> <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_index'>index</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
    <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_resolvers'>single_resolvers</span><span class='period'>.</span><span class='id identifier rubyid_insert'>insert</span><span class='lparen'>(</span><span class='id identifier rubyid_index'>index</span><span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='comment'>#       }
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reset_attributes-instance_method">
  
    #<strong>reset_attributes</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: all</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


859
860
861
862
863
864</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 859</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_attributes'>reset_attributes</span> <span class='comment'># :nodoc: all
</span>  <span class='comment'>#  data structures
</span>  <span class='comment'>#       @mutex=Mutex.new
</span>  <span class='ivar'>@query_list</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='ivar'>@timeouts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_async-instance_method">
  
    #<strong>send_async</strong>(msg, client_queue, client_query_id = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 865</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_async'>send_async</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'>#  This is the whole point of the Resolver class.
</span>  <span class='comment'>#  We want to use multiple SingleResolvers to run a query.
</span>  <span class='comment'>#  So we kick off a system with select_thread where we send
</span>  <span class='comment'>#  a query with a queue, but log ourselves as observers for that
</span>  <span class='comment'>#  queue. When a new response is pushed on to the queue, then the
</span>  <span class='comment'>#  select thread will call this class&#39; handler method IN THAT THREAD.
</span>  <span class='comment'>#  When the final response is known, this class then sticks it in
</span>  <span class='comment'>#  to the client queue.
</span>
  <span class='id identifier rubyid_q'>q</span> <span class='op'>=</span> <span class='const'>Queue</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_client_query_id'>client_query_id</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>10000</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span><span class='lparen'>(</span><span class='const'>Queue</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_log_and_raise'>log_and_raise</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Wrong type for client_queue in Resolver# send_async</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='comment'>#  @TODO@ Handle different queue tuples - push this to generic send_error method
</span>    <span class='id identifier rubyid_client_queue'>client_queue</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Wrong type of client_queue passed to Dnsruby::Resolver# send_async - should have been Queue, was #{client_queue.class}</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span><span class='const'>Message</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Wrong type for msg in Resolver# send_async</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span>
    <span class='comment'>#  @TODO@ Handle different queue tuples - push this to generic send_error method
</span>    <span class='id identifier rubyid_client_queue'>client_queue</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Wrong type of msg passed to Dnsruby::Resolver# send_async - should have been Message, was </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_encode'>encode</span>
  <span class='kw'>rescue</span> <span class='const'><span class='object_link'><a href="EncodeError.html" title="Dnsruby::EncodeError (class)">EncodeError</a></span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_err'>err</span>
    <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Can&#39;t encode </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_err'>err</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_client_queue'>client_queue</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_err'>err</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tick_needed'>tick_needed</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='comment'>#  add to our data structures
</span>  <span class='comment'>#       @mutex.synchronize{
</span>  <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_res_mutex'>single_res_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='id identifier rubyid_tick_needed'>tick_needed</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='ivar'>@query_list</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='kw'>if</span> <span class='ivar'>@query_list</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>
      <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Duplicate query id requested (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='comment'>#  @TODO@ Handle different queue tuples - push this to generic send_error method
</span>      <span class='id identifier rubyid_client_queue'>client_queue</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Client query ID already in use</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_outstanding'>outstanding</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span><span class='op'>=</span><span class='lbracket'>[</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_q'>q</span><span class='comma'>,</span> <span class='id identifier rubyid_outstanding'>outstanding</span><span class='rbracket'>]</span>

    <span class='id identifier rubyid_query_timeout'>query_timeout</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_query_timeout'>query_timeout</span>
    <span class='kw'>if</span> <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_query_timeout'>query_timeout</span> <span class='op'>==</span> <span class='int'>0</span>
      <span class='id identifier rubyid_query_timeout'>query_timeout</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='int'>31536000</span> <span class='comment'># a year from now
</span>    <span class='kw'>end</span>
    <span class='ivar'>@timeouts</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_query_timeout'>query_timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_generate_timeouts'>generate_timeouts</span><span class='rbracket'>]</span>
  <span class='rbrace'>}</span>

  <span class='comment'>#  Now do querying stuff using SingleResolver
</span>  <span class='comment'>#  All this will be handled by the tick method (if we have 0 as the first timeout)
</span>  <span class='id identifier rubyid_st'>st</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="SelectThread.html" title="Dnsruby::SelectThread (class)">SelectThread</a></span></span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span>
  <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_add_observer'>add_observer</span><span class='lparen'>(</span><span class='id identifier rubyid_q'>q</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_tick'>tick</span> <span class='kw'>if</span> <span class='id identifier rubyid_tick_needed'>tick_needed</span>
  <span class='id identifier rubyid_client_query_id'>client_query_id</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_result-instance_method">
  
    #<strong>send_result</strong>(client_queue, client_query_id, select_queue, msg, error)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>MUST BE CALLED IN A SYNCHRONIZED BLOCK!</p>

<pre class="code ruby"><code class="ruby">Sends the result to the client&#39;s queue, and removes the queue observer from the select thread
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


971
972
973
974
975
976
977
978
979
980
981
982</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 971</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_result'>send_result</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span> <span class='comment'># :nodoc: all
</span>  <span class='id identifier rubyid_stop_querying'>stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>  <span class='comment'># @TODO@ !
</span>  <span class='comment'>#  We might still get some callbacks, which we should ignore
</span>  <span class='id identifier rubyid_st'>st</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="SelectThread.html" title="Dnsruby::SelectThread (class)">SelectThread</a></span></span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span>
  <span class='id identifier rubyid_st'>st</span><span class='period'>.</span><span class='id identifier rubyid_remove_observer'>remove_observer</span><span class='lparen'>(</span><span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='kw'>self</span><span class='rparen'>)</span>
  <span class='comment'>#       @mutex.synchronize{
</span>  <span class='comment'>#  Remove the query from all of the data structures
</span>  <span class='ivar'>@query_list</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>
  <span class='comment'>#       }
</span>  <span class='comment'>#  Return the response to the client
</span>  <span class='id identifier rubyid_client_queue'>client_queue</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rbracket'>]</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_result_and_stop_querying-instance_method">
  
    #<strong>send_result_and_stop_querying</strong>(client_queue, client_query_id, select_queue, msg, error)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>MUST BE CALLED IN A SYNCHRONIZED BLOCK!</p>

<pre class="code ruby"><code class="ruby">Send the result back to the client, and close the socket for that query by removing
the query from the select thread.
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


956
957
958
959</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 956</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_result_and_stop_querying'>send_result_and_stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span> <span class='comment'># :nodoc: all
</span>  <span class='id identifier rubyid_stop_querying'>stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_send_result'>send_result</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stop_querying-instance_method">
  
    #<strong>stop_querying</strong>(client_query_id)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>MUST BE CALLED IN A SYNCHRONIZED BLOCK!</p>

<pre class="code ruby"><code class="ruby">Stops send any more packets for a client-level query
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


964
965
966</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 964</span>

<span class='kw'>def</span> <span class='id identifier rubyid_stop_querying'>stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span> <span class='comment'># :nodoc: all
</span>  <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="tick-instance_method">
  
    #<strong>tick</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method is called twice a second from the select loop, in the select thread.</p>

<pre class="code ruby"><code class="ruby">It should arguably be called from another worker thread... (which also handles the queue)
Each tick, we check if any timeouts have occurred. If so, we take the appropriate action :
Return a timeout to the client, or send a new query
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


988
989
990
991
992
993
994
995
996
997
998
999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/dnsruby/resolver.rb', line 988</span>

<span class='kw'>def</span> <span class='id identifier rubyid_tick'>tick</span> <span class='comment'># :nodoc: all
</span>  <span class='comment'>#  Handle the tick
</span>  <span class='comment'>#  Do we have any retries due to be sent yet?
</span>  <span class='comment'>#       @mutex.synchronize{
</span>  <span class='ivar'>@parent</span><span class='period'>.</span><span class='id identifier rubyid_single_res_mutex'>single_res_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='lbrace'>{</span>
    <span class='id identifier rubyid_time_now'>time_now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
    <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='op'>|</span>
      <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_outstanding'>outstanding</span> <span class='op'>=</span> <span class='ivar'>@query_list</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_query_timeout'>query_timeout</span><span class='comma'>,</span> <span class='id identifier rubyid_timeouts'>timeouts</span> <span class='op'>=</span> <span class='ivar'>@timeouts</span><span class='lbracket'>[</span><span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='rbracket'>]</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_query_timeout'>query_timeout</span> <span class='op'>&lt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
        <span class='comment'>#  Time the query out
</span>        <span class='id identifier rubyid_send_result_and_stop_querying'>send_result_and_stop_querying</span><span class='lparen'>(</span><span class='id identifier rubyid_client_queue'>client_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span>
            <span class='const'><span class='object_link'><a href="ResolvTimeout.html" title="Dnsruby::ResolvTimeout (class)">ResolvTimeout</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Query timed out</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_timeouts_done'>timeouts_done</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_timeouts'>timeouts</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_timeout'>timeout</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_timeout'>timeout</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_time_now'>time_now</span>
          <span class='comment'>#  Send the next query
</span>          <span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>=</span> <span class='id identifier rubyid_timeouts'>timeouts</span><span class='lbracket'>[</span><span class='id identifier rubyid_timeout'>timeout</span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_client_query_id'>client_query_id</span><span class='comma'>,</span> <span class='id identifier rubyid_retry_count'>retry_count</span><span class='rbracket'>]</span>
          <span class='const'><span class='object_link'><a href="../Dnsruby.html" title="Dnsruby (module)">Dnsruby</a></span></span><span class='period'>.</span><span class='id identifier rubyid_log'><span class='object_link'><a href="../Dnsruby.html#log-class_method" title="Dnsruby.log (method)">log</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sending msg to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_server'>server</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
          <span class='comment'>#  We should keep a list of the queries which are outstanding
</span>          <span class='id identifier rubyid_outstanding'>outstanding</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_timeouts_done'>timeouts_done</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_timeouts'>timeouts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='rparen'>)</span>

          <span class='comment'>#  Pick a new QID here @TODO@ !!!
</span>          <span class='comment'>#               msg.header.id = rand(65535);
</span>          <span class='comment'>#               print &quot;New query : #{new_msg}\n&quot;
</span>          <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_send_async'>send_async</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_select_queue'>select_queue</span><span class='comma'>,</span> <span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='kw'>break</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_timeouts_done'>timeouts_done</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span> <span class='id identifier rubyid_timeouts'>timeouts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_t'>t</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Apr  9 10:58:11 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-3.0.0).
</div>

    </div>
  </body>
</html>